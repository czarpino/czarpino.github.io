<!DOCTYPE html>
<html lang="en">
    <head>
        <link href='http://fonts.googleapis.com/css?family=Noto+Serif:400,400italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Playfair+Display:900' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Anonymous+Pro' rel='stylesheet' type='text/css'>
        <link rel="icon" type="image/png" href="../../favicon.png">
        <title>Refresh Entity on Failed Validation</title>
        <link rel="stylesheet" href="../../css/style.css">
    </head>
    <body>
        <section>
            <header id="header">
                <section id="headerContainer">
                    <a href="/" id="homeLink">
                        czarpino@github-pages
                    </a>
                    <span id="copyright">
                        &copy;&nbsp;2013
                    </span>
                </section>
            </header>
            <section id="main">
                <article class="mainArticle">
                    <header class="articleHeader">
                        <h1 class="articleTitle">
                            Refresh Entity on Failed Validation
                        </h1>
                    </header>
                    <section class="articleBody">
                        <p>
                        An often overlooked step when updating an entity is reverting invalid changes. While often unnecessary, doing so is borderline good practice.
                        </p>
                        <p>
                        Here is a typical edit controller which renders a pre-filled form and validates changes to the entity being edited.
                        </p>
                        <pre><code>/**
 * Edit user attributes
 *
 * @param Request $request HTTP request object
 *
 * @return Response HTTP response object
 */
public function editUserAction(Request $request)
{
    $em = $this->getDoctrine()->getEntityManager();

    $user = $em->getRepository('FooDemoBundle:User')
               ->find($request->get('user_slug'));

    $userForm = $this->createForm(new UserType(), $user);

    if ('POST' === $request->getMethod()) {
        $userForm->bind($request->request->get($userForm->getName()));

        $isValid = $userForm->isValid();

        if ($isValid) {
            $em->flush();
            return $this->redirect($this->generateUrl('view_user'));
        }
    }

    return $this->render('FooDemoBundle:User:edit_user.html.twig', array (
        'userForm' => $userForm->createView(),
    ));
}</code></pre>
                        <p>
                        Since invoking <code>$userForm->bind(...)</code> also updates <code>$user</code> with the bound values, lines past <code>$userForm->bind(...)</code> will only have access to a <code>$user</code> object having the new attribute values.
                        </p>
                        <pre><code>// $user->getSlug() >> 'foo'

$userForm->bind($request->request->get($userForm->getName()));

// $user->getSlug() >> 'bar'</code></pre>
                        <p>
                        While this behavior conveniently saves additional code for updating the entity's attributes, it is especially undesirable when the updated values are invalid, and <code>$user</code> has to be used later in the controller, or in the template.
                        </p>
                        <p>
                        Since binding behavior is inherent to the form, the most convenient solution would be to revert the attribute values of the entity. To this end, Doctrine's <code>EntityManager</code> has <code>refresh()</code> which removes unpersisted changes to an entity.
                        </p>
                        <pre><code>$userForm->bind($request->request->get($userForm->getName()));

...

if (!isValid) {

    // Revert attribute values
    $em->refresh($foo);
}</code></pre>
                    </section>
                    <footer class="articleFooter">
                        Published <time datetime="2009-11-13">June 2013</time>
                    </footer>
                </article>
            </section>
            <aside class="aside">
                <section class="mainAside">
                </section>
            </aside>
        </section>
    </body>
</html>